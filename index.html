<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Dashboard OEE - Poprawiony i Uproszczony</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif; /* [cite: 1] */
            background: #f4f4f4; /* [cite: 2] */
            margin: 0; /* [cite: 2] */
            padding: 10px; /* [cite: 2] */
            color: #333; /* [cite: 2] */
        }
        .container {
            max-width: 100%; /* [cite: 3] */
            margin: auto; /* [cite: 3] */
            background: white; /* [cite: 3] */
            padding: 10px; /* [cite: 3] */
            border-radius: 10px; /* [cite: 3] */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* [cite: 3] */
        }
        .header-image {
            width: 100%; /* [cite: 4] */
            height: auto; /* [cite: 5] */
            display: block; /* [cite: 5] */
            margin-bottom: 10px; /* [cite: 5] */
            border-radius: 10px; /* [cite: 5] */
        }
        table {
            width: 100%; /* [cite: 6] */
            border-collapse: collapse; /* [cite: 6] */
            margin-bottom: 15px; /* [cite: 6] */
            font-size: 12px; /* [cite: 6] */
            table-layout: fixed; /* [cite: 6] */
        }
        th, td {
            border: 1px solid #ccc; /* [cite: 7] */
            padding: 6px; /* [cite: 7] */
            text-align: center; /* [cite: 7] */
        }
        .red {
            color: red; /* [cite: 8] */
            font-weight: bold; /* [cite: 8] */
        }
        select {
            font-size: 14px; /* [cite: 9] */
            padding: 4px; /* [cite: 9] */
            border-radius: 4px; /* [cite: 9] */
            border: 1px solid #ccc; /* [cite: 9] */
            width: 100%; /* [cite: 9] */
            max-width: 200px; /* [cite: 9] */
        }

        /* Styl dla głównego pola daty/wskaźnika */
        #mainDisplayField {
            font-size: 20px; /* [cite: 10] */
            font-weight: bold; /* [cite: 11] */
            color: #333; /* [cite: 11] */
        }

        /* Ogólny styl dla wszystkich pól danych */
        .data-field {
            font-size: 14px; /* [cite: 12] */
            font-weight: 500; /* [cite: 12] */
        }

        /* Warunkowe style dla OEE i procentów godzinowych */
        .oee-below-60 { background-color: #ff4d4d; color: white; } /* Czerwony */
        .oee-60-70 { background-color: #ff9933; color: black; } /* Pomarańczowy */
        .oee-70-80 { background-color: #ffff66; color: black; } /* Żółty */
        .oee-above-80 { background-color: #66cc66; color: black; } /* Zielony */


        .time-block {
            margin-bottom: 20px; /* [cite: 13] */
        }
        .time-table {
            width: 100%; /* [cite: 14] */
            border-collapse: collapse; /* [cite: 14] */
            table-layout: fixed; /* [cite: 14] */
        }
        .time-table th {
            background: #3498db; /* [cite: 15] */
            color: white; /* [cite: 15] */
            padding: 6px; /* [cite: 15] */
            font-size: 11px; /* [cite: 15] */
        }
        .time-table td {
            border: 1px solid #ccc; /* [cite: 16] */
            padding: 10px; /* [cite: 16] */
            height: 30px; /* [cite: 16] */
            background-color: #fff; /* [cite: 16] */
            font-size: 16px; /* Zwiększona czcionka dla wszystkich komórek czasowych - zmienione z 12px w załączniku */
            font-weight: bold; /* Dodany font-weight */
        }
        .time-header th {
            text-align: center; /* [cite: 17] */
            font-weight: bold; /* [cite: 17] */
        }
        /* NOWA KLASA DLA WIERSZA _r1 (procenty godzinowe) */
        .time-r1-font {
            font-size: 20px; /* PRZYKŁADOWA WIĘKSZA CZCIONKA DLA _r1 */
            color: #1a5e8c; 
        }
        @media (max-width: 600px) {
            th, td {
                padding: 4px; /* [cite: 18] */
                font-size: 11px; /* [cite: 18] */
            }
            .time-table th, .time-table td {
                padding: 6px; /* [cite: 19] */
                font-size: 14px; /* Dopasowanie czcionki godzinowej dla mniejszych ekranów - zmienione z 10px w załączniku */
            }
            select {
                max-width: 100%; /* [cite: 20] */
            }
            #mainDisplayField {
                font-size: 16px; /* [cite: 21] */
            }
            .data-field {
                font-size: 12px; /* [cite: 22] */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <img class="header-image" src="https://via.placeholder.com/1200x100.png?text=Nagłówek+Pulpitu+OEE" alt="_______Dawid - spokojnie, ogarniemy:) ;) ">

        <table>
            <tr>
                <td id="mainDisplayField"><strong>Wybierz linię</strong></td>
                <td colspan="4">
                    <select id="sheetSelector"> /* [cite: 23] */
                        <option value="">Wybierz linię</option> /* [cite: 23] */
                        <option>NHL</option> /* [cite: 23] */
                        <option>MP4</option> /* [cite: 23] */
                        <option>Hood Latch</option> /* [cite: 24] */
                        <option>M4</option> /* [cite: 24] */
                        <option>H-Latch GŁÓWNA</option> /* [cite: 24] */
                        <option>H-Latch PIANA</option> /* [cite: 24] */
                        <option>139 P</option> /* [cite: 25] */
                        <option>139 T</option> /* [cite: 25] */
                        <option>SV3 A9</option> /* [cite: 25] */
                        <option>Pokrywki</option> /* [cite: 25] */
                        <option>Cardrige</option> /* [cite: 26] */
                    </select>
                </td>
            </tr>
            <tr>
                <td><strong>zm</strong></td>
                <td>I</td>
                <td>II</td> /* [cite: 27] */
                <td>III</td> /* [cite: 27] */
                <td><strong>TOTAL</strong></td> /* [cite: 27] */
            </tr>
            <tr>
                <td><strong>OEE</strong></td>
                <td id="oeeShift1" class="data-field"></td> /* [cite: 28] */
                <td id="oeeShift2" class="data-field"></td> /* [cite: 28] */
                <td id="oeeShift3" class="data-field"></td> /* [cite: 28] */
                <td id="oeeTotal" class="data-field"></td> /* [cite: 28] */
            </tr>
            <tr>
                <td><strong>OK</strong></td>
                <td id="okShift1" class="data-field"></td> /* [cite: 29] */
                <td id="okShift2" class="data-field"></td> /* [cite: 29] */
                <td id="okShift3" class="data-field"></td> /* [cite: 29] */
                <td id="okTotal" class="data-field"></td> /* [cite: 29] */
            </tr>
            <tr>
                <td class="red">NOK</td> /* [cite: 30] */
                <td id="nokShift1" class="data-field"></td> /* [cite: 30] */
                <td id="nokShift2" class="data-field"></td> /* [cite: 30] */
                <td id="nokShift3" class="data-field"></td> /* [cite: 30] */
                <td id="nokTotal" class="data-field"></td> /* [cite: 30] */
            </tr>
        </table> /* [cite: 31] */

        <div class="time-block">
            <table class="time-table">
                <tr class="time-header">
                    <th>6–7</th><th>7–8</th><th>8–9</th><th>9–10</th>
                    <th>10–11</th><th>11–12</th><th>12–13</th><th>13–14</th>
                </tr>
                <tr>
                    <td id="h6_r1" class="time-r1-font"></td> /* [cite: 32] */
                    <td id="h7_r1" class="time-r1-font"></td> /* [cite: 32] */
                    <td id="h8_r1" class="time-r1-font"></td> /* [cite: 32] */
                    <td id="h9_r1" class="time-r1-font"></td> /* [cite: 32] */
                    <td id="h10_r1" class="time-r1-font"></td> /* [cite: 33] */
                    <td id="h11_r1" class="time-r1-font"></td> /* [cite: 33] */
                    <td id="h12_r1" class="time-r1-font"></td> /* [cite: 33] */
                    <td id="h13_r1" class="time-r1-font"></td> /* [cite: 33] */
                </tr>
                <tr>
                    <td id="h6_r2"></td> /* [cite: 34] */
                    <td id="h7_r2"></td> /* [cite: 34] */
                    <td id="h8_r2"></td> /* [cite: 34] */
                    <td id="h9_r2"></td> /* [cite: 34] */
                    <td id="h10_r2"></td> /* [cite: 35] */
                    <td id="h11_r2"></td> /* [cite: 35] */
                    <td id="h12_r2"></td> /* [cite: 35] */
                    <td id="h13_r2"></td> /* [cite: 35] */
                </tr>
            </table> /* [cite: 36] */
        </div>

        <div class="time-block">
            <table class="time-table">
                <tr class="time-header">
                    <th>14–15</th><th>15–16</th><th>16–17</th><th>17–18</th>
                    <th>18–19</th><th>19–20</th><th>20–21</th><th>21–22</th>
                </tr> /* [cite: 37] */
                <tr>
                    <td id="h14_r1" class="time-r1-font"></td> /* [cite: 37] */
                    <td id="h15_r1" class="time-r1-font"></td> /* [cite: 37] */
                    <td id="h16_r1" class="time-r1-font"></td> /* [cite: 38] */
                    <td id="h17_r1" class="time-r1-font"></td> /* [cite: 38] */
                    <td id="h18_r1" class="time-r1-font"></td> /* [cite: 38] */
                    <td id="h19_r1" class="time-r1-font"></td> /* [cite: 38] */
                    <td id="h20_r1" class="time-r1-font"></td> /* [cite: 38] */
                    <td id="h21_r1" class="time-r1-font"></td> /* [cite: 38] */
                </tr> /* [cite: 39] */
                <tr>
                    <td id="h14_r2"></td> /* [cite: 39] */
                    <td id="h15_r2"></td> /* [cite: 39] */
                    <td id="h16_r2"></td> /* [cite: 40] */
                    <td id="h17_r2"></td> /* [cite: 40] */
                    <td id="h18_r2"></td> /* [cite: 40] */
                    <td id="h19_r2"></td> /* [cite: 40] */
                    <td id="h20_r2"></td> /* [cite: 40] */
                    <td id="h21_r2"></td> /* [cite: 40] */
                </tr> /* [cite: 41] */
            </table>
        </div>

        <div class="time-block">
            <table class="time-table">
                <tr class="time-header">
                    <th>22–23</th><th>23–00</th><th>00–01</th><th>01–02</th>
                    <th>02–03</th><th>03–04</th><th>04–05</th><th>05–06</th> /* [cite: 42] */
                </tr>
                <tr>
                    <td id="h22_r1" class="time-r1-font"></td> /* [cite: 42] */
                    <td id="h23_r1" class="time-r1-font"></td> /* [cite: 43] */
                    <td id="h0_r1" class="time-r1-font"></td> /* [cite: 43] */
                    <td id="h1_r1" class="time-r1-font"></td> /* [cite: 43] */
                    <td id="h2_r1" class="time-r1-font"></td> /* [cite: 43] */
                    <td id="h3_r1" class="time-r1-font"></td> /* [cite: 43] */
                    <td id="h4_r1" class="time-r1-font"></td> /* [cite: 44] */
                    <td id="h5_r1" class="time-r1-font"></td> /* [cite: 44] */
                </tr>
                <tr>
                    <td id="h22_r2"></td> /* [cite: 44] */
                    <td id="h23_r2"></td> /* [cite: 45] */
                    <td id="h0_r2"></td> /* [cite: 45] */
                    <td id="h1_r2"></td> /* [cite: 45] */
                    <td id="h2_r2"></td> /* [cite: 45] */
                    <td id="h3_r2"></td> /* [cite: 45] */
                    <td id="h4_r2"></td> /* [cite: 46] */
                    <td id="h5_r2"></td> /* [cite: 46] */
                </tr>
            </table>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sheetId = '1gcWHcIZv7OMuU1bNNQ5P7XFLNpLoBsabXbG9hJImGpc'; /* [cite: 47] */
    const sheetSelector = document.getElementById('sheetSelector'); /* [cite: 47] */
    const mainDisplayField = document.getElementById('mainDisplayField'); /* [cite: 47] */

    // Funkcja do konwersji litery kolumny na indeks liczbowy (0-indexed)
    function getGoogleSheetColumnIndex(colLetter) {
        let colIndex = 0; /* [cite: 48] */
        for (let i = 0; i < colLetter.length; i++) { /* [cite: 48] */
            colIndex = colIndex * 26 + (colLetter.charCodeAt(i) - 'A'.charCodeAt(0) + 1); /* [cite: 49] */
        }
        return colIndex - 1; /* [cite: 50] */
    }

    // Funkcja pomocnicza do parsowania CSV
    function parseCsv(csvString) {
        const lines = csvString.trim().split('\n'); /* [cite: 51] */
        return lines.map(line => { /* [cite: 51] */
            return line.split(',').map(cell => { /* [cite: 51] */
                let cleanedCell = cell.trim(); /* [cite: 51] */
                if (cleanedCell.startsWith('"') && cleanedCell.endsWith('"')) { /* [cite: 51] */
                    cleanedCell = cleanedCell.substring(1, cleanedCell.length - 1); /* [cite: 51] */
                }
                return cleanedCell.replace(/""/g, '"'); /* [cite: 52] */
            });
        });
    }

    // Funkcja do formatowania daty z numeru seryjnego Google Sheets lub tekstowego formatu
    function formatGoogleSheetDate(serialOrDateString) {
        if (!serialOrDateString || String(serialOrDateString).trim() === '') {
            return ''; 
        }

        let date;
        const numValue = parseFloat(serialOrDateString);

        // Najpierw spróbuj sparsować jako numer seryjny Google Sheets (np. 45078)
        if (!isNaN(numValue) && numValue > 0 && numValue < 60000) { /* [cite: 57] */
            const excelEpoch = new Date(Date.UTC(1899, 11, 30)).getTime(); /* [cite: 57] */
            date = new Date(excelEpoch + (numValue * 86400000)); /* [cite: 57] */
        } else {
            // Jeśli nie jest numerem seryjnym, spróbuj sparsować jako tekst daty (np. '2025-06-02 00:00:00')
            // Używamy `new Date()` które jest dość elastyczne w parsowaniu
            date = new Date(serialOrDateString); /* [cite: 53] */
        }

        // Sprawdź, czy data jest prawidłowa (nie Invalid Date)
        if (isNaN(date.getTime())) {
            return ''; 
        }

        const day = String(date.getDate()).padStart(2, '0'); /* [cite: 58] */
        const month = String(date.getMonth() + 1).padStart(2, '0'); /* [cite: 54, 58] */
        const year = date.getFullYear(); /* [cite: 54, 58] */

        return `${day}.${month}.${year}`; /* [cite: 55, 59] */
    }

    // Funkcja do ustawiania tekstu i stylów w danej komórce HTML
    function setFieldValue(elementId, value, options = {}) {
        const element = document.getElementById(elementId); /* [cite: 61] */
        if (!element) {
            // console.warn(`Element o ID "${elementId}" nie został znaleziony w HTML.`); 
            return;
        }

        let displayValue = '';
        let rawValue = value;

        // Usuń wszystkie poprzednie klasy stylów związanych z kolorowaniem OEE
        element.classList.remove('oee-below-60', 'oee-60-70', 'oee-70-80', 'oee-above-80');
        // Zresetuj styl inline (np. background-color, color), jeśli były ustawione
        element.style.backgroundColor = '';
        element.style.color = '';

        // KROK 1: Jeśli to data, sformatuj i ustaw. Zawsze powinna się wyświetlać, jeśli jest prawidłowa.
        if (options.isDate) {
            displayValue = formatGoogleSheetDate(rawValue); /* [cite: 63] */
            element.textContent = displayValue; /* [cite: 64] */
            return; 
        }

        // KROK 2: Obsługa wartości pustych lub "0" dla innych pól (szczególnie procentów i liczb)
        // Jeśli wartość jest pusta, null, undefined, pustym stringiem lub liczbowym zerem, ukryj.
        if (rawValue === '' || rawValue === null || rawValue === undefined || String(rawValue).trim() === '' || parseFloat(rawValue) === 0) {
            element.textContent = ''; 
            return; 
        }

        // KROK 3: Jeśli to procent, sformatuj i pokoloruj.
        if (options.isPercentage) {
            const numValue = parseFloat(rawValue);
            if (!isNaN(numValue)) {
                let percentageValue = numValue;
                // Jeśli wartość jest ułamkiem (np. 0.74), to mnożymy przez 100
                if (numValue > 0 && numValue < 1.0) { 
                    percentageValue = numValue * 100;
                }
                
                displayValue = `${percentageValue.toFixed(0)}%`; 
                
                // Warunkowe formatowanie kolorystyczne
                const normalizedValue = percentageValue / 100; 

                if (normalizedValue < 0.60) {
                    element.classList.add('oee-below-60');
                } else if (normalizedValue >= 0.60 && normalizedValue < 0.70) {
                    element.classList.add('oee-60-70');
                } else if (normalizedValue >= 0.70 && normalizedValue < 0.80) {
                    element.classList.add('oee-70-80');
                } else { // >= 0.80
                    element.classList.add('oee-above-80');
                }
            } else {
                displayValue = rawValue; // Jeśli nie jest liczbą, wyświetl jak jest
            }
        } 
        // KROK 4: W pozostałych przypadkach (zwykłe liczby), po prostu wyświetl surową wartość.
        else {
            displayValue = rawValue;
        }
        element.textContent = displayValue; /* [cite: 65] */
    }

    // --- MAPOWANIE PÓL HTML DO KOMÓREK W ARKUSZU GOOGLE ---
    // WAŻNE: Wartości `row` odpowiadają TERAZ BEZPOŚREDNIO numerom wierszy w Arkuszu Google.
    // 'mainDisplayField' (data) to C1
    // 'oeeTotal' (TOTAL) to C3
    const cellMappings = {
        'mainDisplayField': { row: 1, col: 'C', isDate: true }, // Data z C1 /* [cite: 65] */

        'oeeShift1': { row: 3, col: 'D', isPercentage: true, cellClass: 'data-field' }, // Zmienione z 2 na 3
        'oeeShift2': { row: 3, col: 'E', isPercentage: true, cellClass: 'data-field' }, // Zmienione z 2 na 3
        'oeeShift3': { row: 3, col: 'F', isPercentage: true, cellClass: 'data-field' }, // Zmienione z 2 na 3
        'oeeTotal': { row: 3, col: 'C', isPercentage: true, cellClass: 'data-field' }, // OEE TOTAL z C3 - zmienione z 2 na 3

        'okShift1': { row: 10, col: 'D', cellClass: 'data-field' }, // Zmienione z 9 na 10 /* [cite: 66] */
        'okShift2': { row: 10, col: 'E', cellClass: 'data-field' }, // Zmienione z 9 na 10 /* [cite: 66] */
        'okShift3': { row: 10, col: 'F', cellClass: 'data-field' }, // Zmienione z 9 na 10 /* [cite: 66] */
        'okTotal': { row: 10, col: 'C', cellClass: 'data-field' }, // Zmienione z 9 na 10 /* [cite: 66] */

        'nokShift1': { row: 11, col: 'D', cellClass: 'data-field' }, // Zmienione z 10 na 11 /* [cite: 66] */
        'nokShift2': { row: 11, col: 'E', cellClass: 'data-field' }, // Zmienione z 10 na 11 /* [cite: 66] */
        'nokShift3': { row: 11, col: 'F', cellClass: 'data-field' }, // Zmienione z 10 na 11 /* [cite: 66] */
        'nokTotal': { row: 11, col: 'C', cellClass: 'data-field' }, // Zmienione z 10 na 11 /* [cite: 66] */

        // GODZINY - WIERSZ 1 (procenty)
        'h6_r1': { row: 15, col: 'E', isPercentage: true }, // Zmienione z 14 na 15 /* [cite: 67] */
        'h7_r1': { row: 16, col: 'E', isPercentage: true }, // Zmienione z 15 na 16 /* [cite: 67] */
        'h8_r1': { row: 17, col: 'E', isPercentage: true }, // Zmienione z 16 na 17 /* [cite: 67] */
        'h9_r1': { row: 18, col: 'E', isPercentage: true }, // Zmienione z 17 na 18 /* [cite: 67] */
        'h10_r1': { row: 19, col: 'E', isPercentage: true }, // Zmienione z 18 na 19 /* [cite: 67] */
        'h11_r1': { row: 20, col: 'E', isPercentage: true }, // Zmienione z 19 na 20 /* [cite: 67] */
        'h12_r1': { row: 21, col: 'E', isPercentage: true }, // Zmienione z 20 na 21 /* [cite: 67] */
        'h13_r1': { row: 22, col: 'E', isPercentage: true }, // Zmienione z 21 na 22 /* [cite: 68] */

        'h14_r1': { row: 23, col: 'E', isPercentage: true }, // Zmienione z 22 na 23 /* [cite: 68] */
        'h15_r1': { row: 24, col: 'E', isPercentage: true }, // Zmienione z 23 na 24 /* [cite: 68] */
        'h16_r1': { row: 25, col: 'E', isPercentage: true }, // Zmienione z 24 na 25 /* [cite: 68] */
        'h17_r1': { row: 26, col: 'E', isPercentage: true }, // Zmienione z 25 na 26 /* [cite: 68] */
        'h18_r1': { row: 27, col: 'E', isPercentage: true }, // Zmienione z 26 na 27 /* [cite: 68] */
        'h19_r1': { row: 28, col: 'E', isPercentage: true }, // Zmienione z 27 na 28 /* [cite: 68] */
        'h20_r1': { row: 29, col: 'E', isPercentage: true }, // Zmienione z 28 na 29 /* [cite: 69] */
        'h21_r1': { row: 30, col: 'E', isPercentage: true }, // Zmienione z 29 na 30 /* [cite: 69] */

        'h22_r1': { row: 31, col: 'E', isPercentage: true }, // Zmienione z 30 na 31 /* [cite: 69] */
        'h23_r1': { row: 32, col: 'E', isPercentage: true }, // Zmienione z 31 na 32 /* [cite: 69] */
        'h0_r1': { row: 33, col: 'E', isPercentage: true }, // Zmienione z 32 na 33 /* [cite: 69] */
        'h1_r1': { row: 34, col: 'E', isPercentage: true }, // Zmienione z 33 na 34 /* [cite: 69] */
        'h2_r1': { row: 35, col: 'E', isPercentage: true }, // Zmienione z 34 na 35 /* [cite: 69, 70] */
        'h3_r1': { row: 36, col: 'E', isPercentage: true }, // Zmienione z 35 na 36 /* [cite: 70] */
        'h4_r1': { row: 37, col: 'E', isPercentage: true }, // Zmienione z 36 na 37 /* [cite: 70] */
        'h5_r1': { row: 38, col: 'E', isPercentage: true }, // Zmienione z 37 na 38 /* [cite: 70] */

        // GODZINY - WIERSZ 2 (nie procentowe)
        'h6_r2': { row: 15, col: 'C' }, // Zmienione z 14 na 15 /* [cite: 70] */
        'h7_r2': { row: 16, col: 'C' }, // Zmienione z 15 na 16 /* [cite: 70] */
        'h8_r2': { row: 17, col: 'C' }, // Zmienione z 16 na 17 /* [cite: 70] */
        'h9_r2': { row: 18, col: 'C' }, // Zmienione z 17 na 18 /* [cite: 70] */
        'h10_r2': { row: 19, col: 'C' }, // Zmienione z 18 na 19 /* [cite: 70, 71] */
        'h11_r2': { row: 20, col: 'C' }, // Zmienione z 19 na 20 /* [cite: 71] */
        'h12_r2': { row: 21, col: 'C' }, // Zmienione z 20 na 21 /* [cite: 71] */
        'h13_r2': { row: 22, col: 'C' }, // Zmienione z 21 na 22 /* [cite: 71] */
        'h14_r2': { row: 23, col: 'C' }, // Zmienione z 22 na 23 /* [cite: 71] */
        'h15_r2': { row: 24, col: 'C' }, // Zmienione z 23 na 24 /* [cite: 71] */
        'h16_r2': { row: 25, col: 'C' }, // Zmienione z 24 na 25 /* [cite: 71] */
        'h17_r2': { row: 26, col: 'C' }, // Zmienione z 25 na 26 /* [cite: 71, 72] */

        'h18_r2': { row: 27, col: 'C' }, // Zmienione z 26 na 27 /* [cite: 72] */
        'h19_r2': { row: 28, col: 'C' }, // Zmienione z 27 na 28 /* [cite: 72] */
        'h20_r2': { row: 29, col: 'C' }, // Zmienione z 28 na 29 /* [cite: 72] */
        'h21_r2': { row: 30, col: 'C' }, // Zmienione z 29 na 30 /* [cite: 72] */
        'h22_r2': { row: 31, col: 'C' }, // Zmienione z 30 na 31 /* [cite: 72] */
        'h23_r2': { row: 32, col: 'C' }, // Zmienione z 31 na 32 /* [cite: 72] */
        'h0_r2': { row: 33, col: 'C' }, // Zmienione z 32 na 33 /* [cite: 72, 73] */
        'h1_r2': { row: 34, col: 'C' }, // Zmienione z 33 na 34 /* [cite: 73] */
        'h2_r2': { row: 35, col: 'C' }, // Zmienione z 34 na 35 /* [cite: 73] */
        'h3_r2': { row: 36, col: 'C' }, // Zmienione z 35 na 36 /* [cite: 73] */
        'h4_r2': { row: 37, col: 'C' }, // Zmienione z 36 na 37 /* [cite: 73] */
        'h5_r2': { row: 38, col: 'C' }, // Zmienione z 37 na 38 /* [cite: 73] */
    }; /* [cite: 74] */

    // Funkcja do czyszczenia wszystkich pól danych (w tym stylów)
    function clearAllDataFields() {
        const allDataElements = document.querySelectorAll('.data-field, .time-table td');
        allDataElements.forEach(element => {
            element.textContent = '';
            // Usuń wszystkie klasy kolorystyczne
            element.classList.remove('oee-below-60', 'oee-60-70', 'oee-70-80', 'oee-above-80');
            // Resetuj style inline, które mogą być ustawione przez JS
            element.style.backgroundColor = '';
            element.style.color = '';
        });
        // Specjalne czyszczenie dla mainDisplayField, które nie ma klasy .data-field
        mainDisplayField.textContent = '';
        mainDisplayField.style.backgroundColor = '';
        mainDisplayField.style.color = '';
    }

    // Główna funkcja do pobierania i aktualizowania danych
    async function updateDashboard() {
        const selectedSheetName = sheetSelector.value; /* [cite: 78] */
        mainDisplayField.innerHTML = '<strong>Ładowanie...</strong>'; /* [cite: 78] */
        clearAllDataFields(); /* [cite: 78] */

        if (!selectedSheetName) {
            mainDisplayField.innerHTML = '<strong>Wybierz linię</strong>'; /* [cite: 79] */
            return; /* [cite: 79] */
        }

        const range = `A1:M50`; /* [cite: 80] */
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(selectedSheetName)}&range=${encodeURIComponent(range)}`; /* [cite: 80] */

        try {
            const response = await fetch(url); /* [cite: 81] */
            if (!response.ok) { /* [cite: 81] */
                throw new Error(`Błąd sieci lub nie można uzyskać dostępu do arkusza (${selectedSheetName}). Status: ${response.status}`); /* [cite: 82] */
            }
            const csvText = await response.text(); /* [cite: 83] */
            const data = parseCsv(csvText); /* [cite: 83] */

            for (const htmlId in cellMappings) {
                const map = cellMappings[htmlId]; /* [cite: 84] */
                // WAŻNE: rowIndexInData to teraz numer wiersza z arkusza (1-bazowy)
                // Do dostępu do tablicy 'data' musimy odjąć 1 (bo tablice są 0-bazowe)
                const rowIndexInData = map.row; 
                const colIndexInData = getGoogleSheetColumnIndex(map.col); /* [cite: 85] */

                if (data[rowIndexInData - 1] && data[rowIndexInData - 1][colIndexInData] !== undefined) { /* [cite: 85] */
                    setFieldValue(htmlId, data[rowIndexInData - 1][colIndexInData], map); /* [cite: 86] */
                } else {
                    setFieldValue(htmlId, '', map); /* [cite: 87] */
                }
            }

        } catch (error) {
            console.error('Błąd podczas pobierania lub przetwarzania danych:', error); /* [cite: 88] */
            mainDisplayField.innerHTML = '<strong>Błąd ładowania danych!</strong>'; /* [cite: 88] */
            clearAllDataFields(); /* [cite: 88] */
        }
    }

    sheetSelector.addEventListener('change', updateDashboard); /* [cite: 89] */

    if (sheetSelector.value) { /* [cite: 89] */
        updateDashboard(); /* [cite: 90] */
    } else {
        mainDisplayField.innerHTML = '<strong>Wybierz linię</strong>'; /* [cite: 90] */
        clearAllDataFields(); /* [cite: 90] */
    }
});
</script>
</body>
</html>
